<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CryptoSphere | Portfolio Tracker</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    fontFamily: { sans: ['Space Grotesk', 'sans-serif'] },
    extend: {
      colors: {
        primary:"#00f5d4", secondary:"#7b2cbf",
        dark:"#0f0e17", light:"#fffffe", card:"#1e1e2e"
      }
    }
  }
}
</script>
</head>

<body class="bg-light dark:bg-dark text-dark dark:text-light font-sans">

<section class="min-h-screen px-4 py-24">
<div class="max-w-4xl mx-auto bg-white dark:bg-card rounded-2xl shadow-xl p-6">

<h1 class="text-3xl font-bold text-center text-primary mb-6">
Portfolio Tracker Kripto
</h1>

<!-- INPUT -->
<div class="space-y-4">
<select id="currencySelect" class="w-full p-3 rounded-lg dark:bg-dark">
<option value="USD">USD ($)</option>
<option value="IDR">IDR (Rp)</option>
</select>

<input id="coinName" placeholder="bitcoin / btc / eth / sol" class="w-full p-3 rounded-lg dark:bg-dark">
<input id="amount" type="number" placeholder="Jumlah koin" class="w-full p-3 rounded-lg dark:bg-dark">
<input id="buyPrice" type="number" placeholder="Harga beli (opsional)" class="w-full p-3 rounded-lg dark:bg-dark">

<button id="addCoinBtn"
class="w-full bg-primary text-black font-bold py-3 rounded-lg">
Tambah Koin
</button>
</div>

<!-- ERROR -->
<div id="apiError" class="hidden mt-4 p-3 bg-red-200 dark:bg-red-900 rounded">
<p class="font-bold">Error:</p>
<p id="apiErrorMessage"></p>
</div>

<!-- SUMMARY -->
<div id="portfolioSummary" class="hidden grid grid-cols-2 gap-4 mt-8">
<div>
<p>Total Value</p>
<p id="totalCurrentValue" class="font-bold"></p>
</div>
<div>
<p>Total Invest</p>
<p id="totalInvested" class="font-bold"></p>
</div>
<div>
<p>Total P/L</p>
<p id="totalProfitLoss" class="font-bold"></p>
</div>
<div>
<p>P/L %</p>
<p id="totalProfitLossPercentage" class="font-bold"></p>
</div>
</div>

<!-- LIST -->
<div id="portfolioList" class="mt-8 space-y-3"></div>

<button id="clearPortfolioBtn"
class="mt-8 w-full bg-red-600 text-white py-3 rounded-lg">
Hapus Semua
</button>

</div>
</section>

<script>
/* ================= CONFIG ================= */
const coinAlias = {
 btc:'bitcoin', eth:'ethereum', sol:'solana',
 bnb:'binancecoin', ada:'cardano',
 xrp:'ripple', doge:'dogecoin'
};

const REFRESH_INTERVAL = 60000;

/* ================= STATE ================= */
let portfolio = JSON.parse(localStorage.getItem('cryptoPortfolio') || '[]');
let refreshInterval;

/* ================= DOM ================= */
const currencySelect = document.getElementById('currencySelect');
const coinNameInput = document.getElementById('coinName');
const amountInput = document.getElementById('amount');
const buyPriceInput = document.getElementById('buyPrice');
const addCoinBtn = document.getElementById('addCoinBtn');
const portfolioList = document.getElementById('portfolioList');
const portfolioSummary = document.getElementById('portfolioSummary');
const apiError = document.getElementById('apiError');
const apiErrorMessage = document.getElementById('apiErrorMessage');

/* ================= HELPERS ================= */
const savePortfolio = () =>
 localStorage.setItem('cryptoPortfolio', JSON.stringify(portfolio));

const formatCurrency = (n) =>
 new Intl.NumberFormat(
   currencySelect.value === 'USD' ? 'en-US' : 'id-ID',
   { style:'currency', currency:currencySelect.value }
 ).format(n);

/* ================= ADD COIN ================= */
addCoinBtn.onclick = () => {
 let name = coinNameInput.value.trim().toLowerCase();
 if (coinAlias[name]) name = coinAlias[name];

 const amount = parseFloat(amountInput.value);
 const buyPrice = parseFloat(buyPriceInput.value) || 0;

 if (!name || amount <= 0) return alert('Input tidak valid');

 const exist = portfolio.find(c => c.name === name);
 if (exist) {
   exist.amount += amount;
   if (buyPrice) exist.buyPrice = buyPrice;
 } else {
   portfolio.push({
     id:Date.now(), name, amount, buyPrice,
     currentPrice:0, currentValue:0, profitLoss:0
   });
 }

 savePortfolio();
 render();
 fetchPrices();
 coinNameInput.value = amountInput.value = buyPriceInput.value = '';
};

/* ================= RENDER ================= */
function render() {
 portfolioList.innerHTML = '';
 if (!portfolio.length) return portfolioSummary.classList.add('hidden');

 portfolioSummary.classList.remove('hidden');

 portfolio.forEach(c => {
  const el = document.createElement('div');
  el.className = 'p-3 rounded bg-gray-100 dark:bg-dark';
  el.innerHTML = `
   <b>${c.name}</b><br>
   Amount: ${c.amount}<br>
   Value: ${formatCurrency(c.currentValue)}<br>
   P/L: ${formatCurrency(c.profitLoss)}
  `;
  portfolioList.appendChild(el);
 });

 updateSummary();
}

/* ================= FETCH PRICE ================= */
async function fetchPrices() {
 apiError.classList.add('hidden');
 if (!portfolio.length) return;

 try {
  const ids = portfolio.map(c=>c.name).join(',');
  const res = await fetch(
   `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd,idr`
  );
  if (!res.ok) throw new Error('API Error / Rate limit');

  const data = await res.json();

  portfolio.forEach(c => {
   const p = data[c.name];
   if (!p) return;

   c.currentPrice = currencySelect.value === 'USD' ? p.usd : p.idr;
   c.currentValue = c.currentPrice * c.amount;
   c.profitLoss = c.buyPrice
    ? (c.currentPrice - c.buyPrice) * c.amount
    : 0;
  });

  savePortfolio();
  render();

 } catch(e) {
  apiError.classList.remove('hidden');
  apiErrorMessage.textContent = e.message;
 }
}

/* ================= SUMMARY ================= */
function updateSummary() {
 let v=0,i=0,p=0;
 portfolio.forEach(c=>{
  v+=c.currentValue;
  i+=c.amount*c.buyPrice;
  p+=c.profitLoss;
 });

 document.getElementById('totalCurrentValue').textContent = formatCurrency(v);
 document.getElementById('totalInvested').textContent = formatCurrency(i);
 document.getElementById('totalProfitLoss').textContent = formatCurrency(p);
 document.getElementById('totalProfitLossPercentage').textContent =
  i ? ((p/i)*100).toFixed(2)+'%' : '0%';
}

/* ================= EVENTS ================= */
let currencyTimeout;
currencySelect.onchange = ()=>{
 clearTimeout(currencyTimeout);
 currencyTimeout = setTimeout(fetchPrices,400);
};

document.getElementById('clearPortfolioBtn').onclick = ()=>{
 if(confirm('Hapus semua?')){
  portfolio=[];
  savePortfolio();
  render();
 }
};

/* ================= INTERVAL SAFE ================= */
function startInterval(){
 refreshInterval = setInterval(fetchPrices, REFRESH_INTERVAL);
}
document.addEventListener('visibilitychange',()=>{
 document.hidden ? clearInterval(refreshInterval) : startInterval();
});

/* ================= INIT ================= */
render();
fetchPrices();
startInterval();
</script>

</body>
</html>
